<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>EDS 217: Python for Environmental Data Science - Lab 1: Estimating Basin Waterbalance</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css">

<link rel="stylesheet" href="styles/activities.css">
</head>

<body class="floating">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#instructions" id="toc-instructions" class="nav-link active" data-scroll-target="#instructions">1. Instructions</a></li>
  <li><a href="#setting-up-the-lab" id="toc-setting-up-the-lab" class="nav-link" data-scroll-target="#setting-up-the-lab">2. Setting up the Lab</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">3. Background</a></li>
  <li><a href="#visualizing-watersheds" id="toc-visualizing-watersheds" class="nav-link" data-scroll-target="#visualizing-watersheds">3.1 Visualizing watersheds</a>
  <ul class="collapse">
  <li><a href="#viewing-watershed-hydrography" id="toc-viewing-watershed-hydrography" class="nav-link" data-scroll-target="#viewing-watershed-hydrography">3.1.1 Viewing Watershed Hydrography</a></li>
  <li><a href="#viewing-basin-topography-using-digital-elevation-data" id="toc-viewing-basin-topography-using-digital-elevation-data" class="nav-link" data-scroll-target="#viewing-basin-topography-using-digital-elevation-data">3.1.2 Viewing Basin Topography Using Digital Elevation Data</a></li>
  </ul></li>
  <li><a href="#a-catchment-as-a-physical-system" id="toc-a-catchment-as-a-physical-system" class="nav-link" data-scroll-target="#a-catchment-as-a-physical-system">3.2 A Catchment as a Physical System</a></li>
  <li><a href="#obtaining-precipitation-discharge-and-rainfall-data-for-a-usgs-station" id="toc-obtaining-precipitation-discharge-and-rainfall-data-for-a-usgs-station" class="nav-link" data-scroll-target="#obtaining-precipitation-discharge-and-rainfall-data-for-a-usgs-station">3.3 Obtaining Precipitation, Discharge, and Rainfall data for a USGS station</a>
  <ul class="collapse">
  <li><a href="#discharge-data-for-our-station" id="toc-discharge-data-for-our-station" class="nav-link" data-scroll-target="#discharge-data-for-our-station">3.3.1 Discharge Data for our Station</a></li>
  <li><a href="#precipitation-data-for-our-station" id="toc-precipitation-data-for-our-station" class="nav-link" data-scroll-target="#precipitation-data-for-our-station">3.3.2 Precipitation Data for our Station</a></li>
  <li><a href="#evapotranspiration-data-for-our-station" id="toc-evapotranspiration-data-for-our-station" class="nav-link" data-scroll-target="#evapotranspiration-data-for-our-station">3.3.3 Evapotranspiration Data for our Station</a></li>
  <li><a href="#summing-fluxes-by-water-year" id="toc-summing-fluxes-by-water-year" class="nav-link" data-scroll-target="#summing-fluxes-by-water-year">3.3.4 Summing Fluxes by Water Year</a></li>
  </ul></li>
  <li><a href="#additional-hydromet-plotting-tools" id="toc-additional-hydromet-plotting-tools" class="nav-link" data-scroll-target="#additional-hydromet-plotting-tools">3.4 Additional Hydromet Plotting tools</a></li>
  <li><a href="#your-assignment" id="toc-your-assignment" class="nav-link" data-scroll-target="#your-assignment">4. Your Assignment</a>
  <ul class="collapse">
  <li><a href="#assessing-basin-water-balance" id="toc-assessing-basin-water-balance" class="nav-link" data-scroll-target="#assessing-basin-water-balance">4.1 Assessing Basin Water Balance</a>
  <ul class="collapse">
  <li><a href="#assign-a-water-year-for-each-entry-in-the-q-et-and-p-dataframes." id="toc-assign-a-water-year-for-each-entry-in-the-q-et-and-p-dataframes." class="nav-link" data-scroll-target="#assign-a-water-year-for-each-entry-in-the-q-et-and-p-dataframes.">4.1.0 Assign a water year for each entry in the <code>Q</code>, <code>ET</code>, and <code>P</code> dataframes.</a></li>
  <li><a href="#convert-discharge-to-units-of-mmday" id="toc-convert-discharge-to-units-of-mmday" class="nav-link" data-scroll-target="#convert-discharge-to-units-of-mmday">4.1.1 Convert Discharge to units of mm/day</a></li>
  <li><a href="#apply-your-q_mm-function-to-the-q-dataframe-to-get-a-new-column-of-q-in-mmday." id="toc-apply-your-q_mm-function-to-the-q-dataframe-to-get-a-new-column-of-q-in-mmday." class="nav-link" data-scroll-target="#apply-your-q_mm-function-to-the-q-dataframe-to-get-a-new-column-of-q-in-mmday.">4.1.2 Apply your <code>Q_mm</code> function to the <code>Q</code> dataframe to get a new column of <code>Q</code> in <code>mm/day</code>.</a></li>
  <li><a href="#create-a-plot-of-the-daily-change-in-storage-over-the-three-water-years." id="toc-create-a-plot-of-the-daily-change-in-storage-over-the-three-water-years." class="nav-link" data-scroll-target="#create-a-plot-of-the-daily-change-in-storage-over-the-three-water-years.">4.1.3 Create a plot of the daily change in storage over the three water years.</a></li>
  <li><a href="#determine-average-monthly-water-balance" id="toc-determine-average-monthly-water-balance" class="nav-link" data-scroll-target="#determine-average-monthly-water-balance">4.1.4 Determine average monthly water balance</a></li>
  <li><a href="#assess-the-degree-to-which-this-basin-is-in-steady-state" id="toc-assess-the-degree-to-which-this-basin-is-in-steady-state" class="nav-link" data-scroll-target="#assess-the-degree-to-which-this-basin-is-in-steady-state">4.1.5 Assess the degree to which this basin is in steady state</a></li>
  <li><a href="#determine-basin-runoff-coefficients" id="toc-determine-basin-runoff-coefficients" class="nav-link" data-scroll-target="#determine-basin-runoff-coefficients">4.1.6 Determine Basin Runoff Coefficients</a></li>
  </ul></li>
  <li><a href="#choose-your-own-basin." id="toc-choose-your-own-basin." class="nav-link" data-scroll-target="#choose-your-own-basin.">4.2 Choose your own basin.</a>
  <ul class="collapse">
  <li><a href="#some-local-gauges-of-possible-interest" id="toc-some-local-gauges-of-possible-interest" class="nav-link" data-scroll-target="#some-local-gauges-of-possible-interest">Some Local Gauges of Possible Interest:</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#extra-stuff-land-use-data" id="toc-extra-stuff-land-use-data" class="nav-link" data-scroll-target="#extra-stuff-land-use-data">5. Extra Stuff: Land Use Data</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">
<hr>
<h4 class="anchored"> <a href="../../">Return to Course Home Page</a></h4>
<hr>

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lab 1: Estimating Basin Waterbalance</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p style="height:1pt">
</p>
<div class="boxhead1">
<pre><code>Lab 1 Contents</code></pre>
</div>
<div class="boxtext1">
<ul class="a">
<li>
üìå Instructions
</li>
<li>
üìå Setting up the Lab
</li>
<li>
üìå Background
</li>
<li>
üìå Lab Assignment
</li>
</ul>
</div>
<hr style="border-top: 0.2px solid gray; margin-top: 12pt; margin-bottom: 0pt">

<section id="instructions" class="level2">
<h2 class="anchored" data-anchor-id="instructions">1. Instructions</h2>
<p>Work through the exercise, writing code where indicated. To run a cell, click on the cell and press ‚ÄúShift‚Äù + ‚ÄúEnter‚Äù or click the ‚ÄúRun‚Äù button in the toolbar at the top. Note: Do not restart the kernel and clear all outputs. If this happens, run the last cell in the notebook before proceeding.</p>
<p style="color:#408000; font-weight: bold">
üêç &nbsp; &nbsp; This symbol designates an important note about Python structure, syntax, or another quirk.
</p>
<p style="color:#443823; font-weight: bold">
üìä &nbsp; &nbsp; This symbol designates an important note about Environmental Data methods, sources, and access.
</p>
<p style="color:#008C96; font-weight: bold">
‚ñ∂Ô∏è &nbsp; &nbsp; This symbol designates a cell with code to be run.
</p>
<p style="color:#008C96; font-weight: bold">
‚úèÔ∏è &nbsp; &nbsp; This symbol designates a partially coded cell with an example.
</p>
<p style="color:#008C96; font-weight: bold">
üìö &nbsp; &nbsp; This symbol designates a practice question.
</p>
<hr style="border-top: 1px solid gray; margin-top: 24px; margin-bottom: 1px">

</section>
<section id="setting-up-the-lab" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-lab">2. Setting up the Lab</h2>
<p><a href="https://hydrodata.readthedocs.io/en/latest/index.html"><code>hydrodata</code></a> is a Python library designed to aid in watershed analysis. Hydrodata is capable of downloading, preprocessing, and visualizing climatological, hydrological, and geographical datasets pertaining to a given watershed. Supported datasets include: Daymet climate, USGS streamflow, and data from the National Land Cover Dataset.</p>
<section id="hydrodata" class="level4">
<h4 class="anchored" data-anchor-id="hydrodata">2.1 Hydrodata</h4>
<p>It‚Äôs easy to use <code>hydrodata</code> to get streamflow data for any USGS gauge. In the background for this lab, we will be looking at some gauges across southern California. Your lab will focus on a stream gauge near to some favorite (or personally interesting) place in the U.S.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hydrodata <span class="im">import</span> Station</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hydrodata.datasets <span class="im">as</span> hds</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="run">
<pre><code>‚ñ∂Ô∏è &lt;b&gt; Run the cell below. &lt;/b&gt;</code></pre>
</div>
<div class="cell" data-execution_count="1">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hydrodata <span class="im">import</span> Station</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hydrodata.datasets <span class="im">as</span> hds</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>) <span class="co"># Don't output warnings</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-error">
<pre><code>ModuleNotFoundError: No module named 'hydrodata'</code></pre>
</div>
</div>
</section>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">3. Background</h2>
<p>This lab is going to give you some first exposure to doing analysis in <code>pandas</code> and creating your own Jupyter notebooks for presenting results and information. The main concept we will be considering is mass balance. Along with energy and momentum, mass is one of the three consitutents that are conserved in environmental systems. More generally, physical systems can be written as a statement of mass, energy, or momentum. The key to creating these statements (or equations) of balance is determining the bounds of the system (its geographic extent and structure) as well as the specific processes acting across those boundaries.</p>
<p>Let‚Äôs take a look at a typical river basin, the upper portions of the Sisquoc River, which is a westward flowing river in northeastern Santa Barbara County, California. The Sisquoc is a tributary of the Santa Maria River, which is formed when the Sisquoc River meets the Cuyama River at the Santa Barbara County and San Luis Obispo County border just north of Garey. The river is 57.4 miles (92.4 km) long and originates on the north slopes of Big Pine Mountain, at approximately 6,320 feet (1,930 m). Big Pine Mountain is part of the San Rafael Mountains, which are part of the Transverse Ranges. Sisquoc is the Chumash word meaning ‚Äúquail‚Äù and the Sisquoc River is a designated National Wild and Scenic River managed by the US Forest Service.</p>
<p>We can use the <a href="https://hydrodata.readthedocs.io/en/latest/usage.html"><code>hydrodata</code></a> library <code>Station</code> object, which we imported earlier. To create an instance of the <code>Station</code> class, we need to specify a USGS <code>station_id</code>, which is a unique code that identifies each of the USGS gauging locations across the United States. In addition, we need to specify a <code>start</code> and an<code>end</code> date for our data request. These dates are used to determine what streamflow data to collect, as well as other meteorological data, which we will see later in the background section.</p>
<p>For this lab, we will be looking at the 2016, 2017, and 2018 water years. Water years are a bit like school years - they start in the fall instead of on January 1st. Specifically, a single water year begins on October 1 and ends on September 30th of the following year. Water years are designated by the calendar years in which they <em>end</em> (e.g.&nbsp;WY 2015 began on October 1, 2014 and ended on September 30, 2015). Therefore, we will start our collection on the 1st of October 2015 and end our data on September 30, 2018.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>station_id <span class="op">=</span> <span class="st">'11138500'</span>  <span class="co"># This is a USGS station ID. Later, I will show you how to find one on your own!</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> <span class="st">'2015-10-01'</span>     <span class="co"># Start date is the Oct. 1, 2015 which is the start of the 2016 water year.</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>end <span class="op">=</span> <span class="st">'2018-09-30'</span>       <span class="co"># End date is the Sept 30, 2018 which is the end of the 2018 water year.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create our watershed object using the station_id, start, and end dates</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>wshed <span class="op">=</span> Station(start<span class="op">=</span>start, end<span class="op">=</span>end, station_id<span class="op">=</span>station_id, data_dir<span class="op">=</span><span class="st">"data/"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="run">
<pre><code>‚ñ∂Ô∏è &lt;b&gt; Run the cell below. &lt;/b&gt;</code></pre>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>station_id <span class="op">=</span> <span class="st">'11138500'</span>  <span class="co"># This is a USGS station ID. Later, I will show you how to find one on your own!</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> <span class="st">'2015-10-01'</span>     <span class="co"># Start date is the Oct. 1, 2015 which is the start of the 2016 water year.</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>end <span class="op">=</span> <span class="st">'2018-09-30'</span>       <span class="co"># End date is the Sept 30, 2018 which is the end of the 2018 water year.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create our watershed object using the station_id, start, and end dates</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>wshed <span class="op">=</span> Station(start<span class="op">=</span>start, end<span class="op">=</span>end, station_id<span class="op">=</span>station_id, data_dir<span class="op">=</span><span class="st">"../data/lab_1/"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="visualizing-watersheds" class="level2">
<h2 class="anchored" data-anchor-id="visualizing-watersheds">3.1 Visualizing watersheds</h2>
<p>A watershed (or catchment, or drainage basin) is any area of land where precipitation collects and drains off into a common outlet, such as into a river, bay, or other body of water. The watershed includes all the surface water from rain, runoff, snowmelt, hail, sleet and nearby streams that run downslope towards the shared outlet, as well as the groundwater underneath the Earth‚Äôs surface. Watersheds are hierarchical, which means they connect into other watersheds at lower elevations, with smaller sub-drainage basins, which in turn drain into another common outlet. This pattern of self-similar, hierarchical structures means that watersheds and their associated stream networks form a stochastic fractal network that collectively routes water and sediment over the Earth‚Äôs surface. Visualizing a watershed requires defining an outlet, which identifies the lowest point of the catchment and the location through which all surface water drains. In this lab, we will define the outlet of a watershed as the location of a USGS streamflow gauge. By linking the definition of our watersheds to the location of streamflow gauges, we will be able to examine the mass balance of the watershed. Before diving into the principles of mass balance as they apply to watersheds, let‚Äôs first spend a little time learning how to acquire and visualize watersheds based on the location of a USGS streamgauge.</p>
<section id="viewing-watershed-hydrography" class="level3">
<h3 class="anchored" data-anchor-id="viewing-watershed-hydrography">3.1.1 Viewing Watershed Hydrography</h3>
<p>We can use some of the dataset interfaces provided by <code>hydrodata</code> to map the stream channels within our watershed.</p>
<div class="data">
<pre><code>üìä &lt;b&gt;HNDPlus&lt;/b&gt;: The best source for hydrography data is the National Hydrography Dataset known as &lt;a href="https://www.usgs.gov/core-science-systems/ngp/national-hydrography/nhdplus-high-resolution"&gt;NHDPlus&lt;/a&gt;. The NHDPlus High Resolution (HR) is a national, geospatial model of the flow of water across the landscape and through the stream network. The NHDPlus HR is built using the National Hydrography Dataset High Resolution data at 1:24,000 scale or better, the 1/3 arc-second (10 meter ground spacing) 3D Elevation Program data, and the nationally complete Watershed Boundary Dataset. </code></pre>
</div>
<p>Access to the NHDPlus dataset is provided by the <code>NLDI</code> object, which is part of <code>hydrodata</code>‚Äôs <code>datasets</code> class, which we imported earlier as <code>hds</code>. To query these datasets, we use the following code:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the hydrography associated with this station using the wshed.station_id:</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>tributaries <span class="op">=</span> hds.NLDI.tributaries(wshed.station_id)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>main_channel <span class="op">=</span> hds.NLDI.main(wshed.station_id)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>stations <span class="op">=</span> hds.NLDI.stations(wshed.station_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="run">
<pre><code>‚ñ∂Ô∏è &lt;b&gt; Run the cell below. &lt;/b&gt;</code></pre>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the hydrography associated with this station using the wshed.station_id:</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>tributaries <span class="op">=</span> hds.NLDI.tributaries(wshed.station_id)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>main_channel <span class="op">=</span> hds.NLDI.main(wshed.station_id)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>stations <span class="op">=</span> hds.NLDI.stations(wshed.station_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can then plot these data using internal <code>hydrodata</code> plotting functions, which are special versions of <code>matplotlib</code> plotting functions with extra features for viewing our stream channels.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a plot of the basin boundaries, main channel, tributaries, and station locations. </span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> wshed.basin.plot(color<span class="op">=</span><span class="st">'white'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, zorder<span class="op">=</span><span class="dv">1</span>, figsize <span class="op">=</span> (<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>tributaries.plot(ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">'Tributaries'</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>main_channel.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'green'</span>, lw<span class="op">=</span><span class="dv">3</span>, label<span class="op">=</span><span class="st">'Main'</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>stations.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'All stations'</span>, marker<span class="op">=</span><span class="st">'s'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">'upper left'</span>)<span class="op">;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>ax.figure.set_dpi(<span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">u'Sisquoc River near Sisquoc, CA (</span><span class="sc">{lon:.2f}</span><span class="ch">\U000000b0</span><span class="st">W, </span><span class="sc">{lat:.2f}</span><span class="ch">\U000000b0</span><span class="st">N)'</span>.<span class="bu">format</span>(</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    lon<span class="op">=</span><span class="bu">abs</span>(my_station.lon),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    lat<span class="op">=</span>my_station.lat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="python">
<pre><code>üêç &lt;b&gt;A Brief Aside About Python &amp; Unicode.&lt;/b&gt; In the code above, we include a &lt;code&gt;u&lt;/code&gt; preceding the string in the &lt;code&gt;ax.set_title()&lt;/code&gt; command. The letter &lt;code&gt;u&lt;/code&gt; before a string is an indicatation that python should convert any &lt;a href="https://en.wikipedia.org/wiki/Unicode"&gt;&lt;code&gt;unicode&lt;/code&gt;&lt;/a&gt; symbols within the string when displaying it. In this case, we included &lt;code&gt;\U000000b0&lt;/code&gt;, which is the unicode symbol for a degree sign (¬∞), so our figure title will include these symbols when we run the code. </code></pre>
<p>You can find the most recent unicode definitions for over one hundred and fifty thousand written characters, symbols, and emojis at <a href="https://unicode-table.com/en/">https://unicode-table.com/en/</a>. Any of these Unicode representations can be expressed in a python string using an encoding that starts with a <code>/code&gt; and is followed by exactly 8 values. Therefore, to use any unicode value in your python strings - for example, the smiling emoji, üòÅ, which is listed as unicode symbol <code>U+1F601</code> - you would include the unicode number (<code>1F601</code>) inside an 8-digit python unicode representation that would look like this: <code>001F601</code>. The most common unicode symbols that were developed first, like the ¬∞ sign, only have 4 digits (<code>U+00b0</code>), so we must add 4 zeros before the symbol to get to a the 8-element representation that python requires: <code>00000b0</code>.</code></p><code>
</code></div><code>
<div class="run">
<pre><code>‚ñ∂Ô∏è &lt;b&gt; Run the cell below. (Feel free to experiment with some unicode characters in the title!)&lt;/b&gt;</code></pre>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a plot of the basin boundaries, main channel, tributaries, and station locations. </span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> wshed.basin.plot(color<span class="op">=</span><span class="st">'white'</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>, zorder<span class="op">=</span><span class="dv">1</span>, figsize <span class="op">=</span> (<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>tributaries.plot(ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">'Tributaries'</span>, zorder<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>main_channel.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'green'</span>, lw<span class="op">=</span><span class="dv">3</span>, label<span class="op">=</span><span class="st">'Main'</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>stations.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'black'</span>, label<span class="op">=</span><span class="st">'All stations'</span>, marker<span class="op">=</span><span class="st">'s'</span>, zorder<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">'upper left'</span>)<span class="op">;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>ax.figure.set_dpi(<span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">u'Sisquoc River near Sisquoc, CA (</span><span class="sc">{lon:.2f}</span><span class="ch">\U000000b0</span><span class="st">W, </span><span class="sc">{lat:.2f}</span><span class="ch">\U000000b0</span><span class="st">N)'</span>.<span class="bu">format</span>(</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    lon<span class="op">=</span><span class="bu">abs</span>(wshed.lon),</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    lat<span class="op">=</span>wshed.lat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In the map above, we can the main branch (green line) of the portion of the Sisquoc River above the town of Sisquoc, CA. The river is flowing in an East-West direction. You can also get a sense of the basin strucuture, which is very typical for a headwater river. There are many side tributaries that extend outward from the main branch, and the overall shape of the basin is such that it is widest just below the mid-point of the main branch. The fractal structure of the draininge network is very apparent.</p>
<div class="data">
<pre><code>üìä &lt;b&gt; Fractal River Basins.&lt;/b&gt;</code></pre>
<p>If you‚Äôd like to learn more about the fractal geometry of river networks and their importance for governing mass and energy fluxes across the land surface, check out <a href="https://www.amazon.com/Fractal-River-Basins-Chance-Self-Organization/dp/0521004055">Fractal River Basins: Chance and Self-Organization</a> written by Ignacio Rodriguez-Iturbe and Andrea Rinaldo.</p>
</div>
</code></section><code>
<section id="viewing-basin-topography-using-digital-elevation-data" class="level3">
<h3 class="anchored" data-anchor-id="viewing-basin-topography-using-digital-elevation-data">3.1.2 Viewing Basin Topography Using Digital Elevation Data</h3>
<p>We can get a better sense of this topography using Digital Elevation Data released by the USGS.</p>
<div class="data">
<pre><code>üìä &lt;b&gt;National Elevation Dataset.&lt;/b&gt; The National Elevation Dataset (NED) is a seamless raster product primarily derived from USGS 10- and 30-meter Digital Elevation Models (DEMs). NED data are available from The National Map Viewer as 1 arc-second (approximately 30 meters) for the CONUS, and at 1/3 and 1/9 arc-seconds (approximately 10 and 3 meters, respectively) for parts of the United States. The NED can be accessed through the &lt;a href="https://www.usgs.gov/core-science-systems/national-geospatial-program/national-map"&gt;National Geospatial Program&lt;/a&gt;. The next generation of US elevation data is being created as part of the &lt;a href="https://www.usgs.gov/core-science-systems/ngp/3dep"&gt;3DEP&lt;/a&gt; program. This program's goal is to complete acquisition of nationwide lidar (IfSAR in AK) by 2023 to provide the first-ever national baseline of consistent high-resolution elevation data ‚Äì both bare earth and 3D point clouds ‚Äì collected in a timeframe of less than a decade. </code></pre>
</div>
<p>The <code>hydrodata</code> library makes it easy to query the National Elevation Dataset to obtain 1 arc-second (~30 meter) digital elevation model (DEM) for any watershed in the United States. Because we already have our basin boundaries, we can make a targeted request to get only the elevation data inside our basin. Then we just make another figure that depicts the elevation data for our basin using a builtin method that is part of the class created by our data request:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Grab the watershed Digital Elevation Data from the USGS:</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>dem <span class="op">=</span> hds.dem_bygeom(wshed.geometry, resolution<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>dem.plot(size<span class="op">=</span><span class="dv">8</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="run">
<pre><code>‚ñ∂Ô∏è &lt;b&gt; Run the cell below. &lt;/b&gt;</code></pre>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Grab the watershed Digital Elevation Data from the USGS:</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>dem <span class="op">=</span> hds.nationalmap_dem(wshed.geometry, resolution<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>dem.plot(size<span class="op">=</span><span class="dv">8</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</code></section><code>
<section id="a-catchment-as-a-physical-system" class="level2">
<h2 class="anchored" data-anchor-id="a-catchment-as-a-physical-system">3.2 A Catchment as a Physical System</h2>
<p>In hydrological sciences, we use the idea of a catchment (or river basin) as the boundary of a system through which water flows. Because water has a relatively constant density (1 g H<sub>2</sub>O = 1 cm<sup>3</sup> H<sub>2</sub>O), we can measure water balance in terms of water volume (m<sup>3</sup>) in addition to water mass (10<sup>3</sup> kg).</p>
<p>The water balance of a catchment is determined by the sum of inputs and outputs of water. If inputs are greater than outputs, the catchment is gaining water. If outputs are greater than inputs, the catchment is losing water. In the special case where outputs and inputs are equal, the catchment is neither gaining nor losing water, and the amount of water in the catchment is constant with time, meaning it is in <em>steady state</em>.</p>
<p>The primary input of water into the land surface is through precipitation (<span class="math inline">P</span> [m<sup>3</sup>]). Precipitation usually takes the form of either rain or snow. There are two main ways that water exits a catchment: (1) the transport of water out of the catchment through streamflow (or river discharge); and (2) the transport of water back into the atmosphere in the form of vapor, which is released from either soils (evaporation, <span class="math inline">E</span> [m<sup>3</sup>]) or plants (transpiration, <span class="math inline">T</span> [m<sup>3</sup>]). For simplicity, we often combine evaporation and transpiration into a single quantity, evapotranspiration (<span class="math inline">ET</span>).</p>
<p>Having specified the important inputs and outputs, the change in storage of water in the catchment (<span class="math inline">\Delta S</span>, [m<sup>3</sup>]) can be written as:</p>
<p><span class="math display"> \Delta S = P - ET - Q </span></p>
<p>In small basins, most of this stored water, <span class="math inline">S</span>, is held in the soil. In larger basins, the storage of water in groundwater can be very important, as can the net movement of groundwater into and out of the basin. Finally, in basins where freezing conditions are common, large amounts of water can be stored as snow and ice.</p>
<p>Usually, we calculate the water balance over discrete time intervals, <span class="math inline">\Delta t</span> (e.g.&nbsp;days, or years), in which case, the equation becomes:</p>
<p><span class="math display">\frac{\Delta S}{\Delta t} = P(t) - ET(t) - Q(t) </span></p>
<p>and we have implicitly re-defined the units of <span class="math inline">P</span>, <span class="math inline">ET</span>, and <span class="math inline">Q</span> to be mass per time, [m<sup>3</sup>/t].</p>
</section>
<section id="obtaining-precipitation-discharge-and-rainfall-data-for-a-usgs-station" class="level2">
<h2 class="anchored" data-anchor-id="obtaining-precipitation-discharge-and-rainfall-data-for-a-usgs-station">3.3 Obtaining Precipitation, Discharge, and Rainfall data for a USGS station</h2>
<p>So far, we‚Äôve been able to define a catchment upstream of a USGS gauge and visualize basin stream networks and topography. In order to study our simple basin water balance, we will need to obtain data on each of the three main fluxes: <span class="math inline">Q</span>, <span class="math inline">P</span>, and <span class="math inline">ET</span>.</p>
<section id="discharge-data-for-our-station" class="level3">
<h3 class="anchored" data-anchor-id="discharge-data-for-our-station">3.3.1 Discharge Data for our Station</h3>
<p>The <code>hydrodata</code> allows us to access streamflow data stored in the National Water Information System (<a href="https://www.usgs.gov/nwis-national-water-information-system">NWIS</a>), which contains water resource data for almost 1.5 million locations across the United States and US Territories. The NWIS contains all station data on streamflow. In addition, it also has all federally-collected data on groundwater levels and water quality. The water quality data includes information on water temperature, conductance, nutrients, pH, pesticides, and volatile organic compounds. In this lab, we will only be looking at streamflow (discharge) data, but you should definitely explore some of the other data available!</p>
<p>We can obtain daily discharge data for our station using the <code>nwis_streamflow</code> method and specifying a <code>station_id</code>, <code>start</code>, and <code>end</code>. These three attributes were stored in the <code>wshed</code> object when we initialized it, so we can grab the values that way. The <code>nwis_streamflow</code> conveniently returns our data as a pandas <code>DataFrame</code>, with a single column of streamflow values indexed by their <code>datetime</code> and reported in cubic meters per second. We use the <code>column</code> method and <code>index.name</code> attribute to clarify what variable and units our new <code>DataFrame</code> contains.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>Q <span class="op">=</span> hds.nwis_streamflow(wshed.station_id, wshed.start, wshed.end)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>Q.columns <span class="op">=</span> [<span class="st">'Q [m^3/s]'</span>]</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>Q.index.name <span class="op">=</span> <span class="st">'Datetime'</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>Q[<span class="st">'Dates'</span>] <span class="op">=</span> Q.index</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>Q.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="run">
<pre><code>‚ñ∂Ô∏è &lt;b&gt; Run the cell below. &lt;/b&gt;</code></pre>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>Q <span class="op">=</span> hds.nwis_streamflow(wshed.station_id, wshed.start, wshed.end)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>Q.columns <span class="op">=</span> [<span class="st">'Q [m^3/s]'</span>]</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>Q.index.name <span class="op">=</span> <span class="st">'Datetime'</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>Q[<span class="st">'Dates'</span>] <span class="op">=</span> Q.index</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>Q.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="precipitation-data-for-our-station" class="level3">
<h3 class="anchored" data-anchor-id="precipitation-data-for-our-station">3.3.2 Precipitation Data for our Station</h3>
<p>Unfortunately, most USGS streamflow gauges aren‚Äôt at locations where rainfall data is also collected. Even if they were, rainfall varies across even small basins, so we‚Äôd still need to have some idea of what the average rainfall was over the entire watershed. Helpfully, the <code>hydromet</code> library includes the ability to query the Daily Surface Weather and Climatological Summaries (<a href="https://daymet.ornl.gov">Daymet</a>), which is hosted at Oak Ridge National Laboratory‚Äôs (ORNL‚Äôs) Distributed Active Archive Center (DAAC).</p>
<div class="data">
<pre><code>üìä &lt;b&gt;The ORNL DAAC:&lt;/b&gt; The ORNL DAAC is the world's largest archive of biogeochemical and spatial environmental data. It contains most of NASA's Earth Observing System satellite data, as well as many contributed data on environmental patterns and processes. In fact, the author's PhD &lt;a href="https://daac.ornl.gov/S2K/guides/kt_stem_map.html"&gt;dissertation data&lt;/a&gt; from 2000 on the location, sizes, and characteristics of 1,000s of savanna trees in southern Africa is hosted on this site. The DAAC maintains a suite of &lt;a href="https://daac.ornl.gov/tools/"&gt;tools&lt;/a&gt; that can be used to query and subset some its largest datasets. Many of these tools - like Daymet - have associated Python libraries that can make access even easier. </code></pre>
</div>
<p>Just as with the NWIS and the NLDI, we will access our daymet data using an interface that is defined in <code>hydrodata</code>‚Äôs <code>datasets</code> module. To begin with, we will just retrieve the meterological data for a single location. The specific method we will use is the <code>daymet_byloc</code> function. This function requires the latitiude and longitude of our location, as well as start and end dates for the observations.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>daymet <span class="op">=</span> hds.daymet_byloc(wshed.lon, wshed.lat, start<span class="op">=</span>wshed.start, end<span class="op">=</span>wshed.end)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="run">
<pre><code>‚ñ∂Ô∏è &lt;b&gt; Run the cell below. &lt;/b&gt;</code></pre>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>daymet <span class="op">=</span> hds.daymet_byloc(wshed.lon, wshed.lat, start<span class="op">=</span>wshed.start, end<span class="op">=</span>wshed.end)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>daymet.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can see that - just like our discharge data stored in <code>Q</code> - the <code>hds.daymet_loc</code> function has returned a pandas <code>Dataframe</code> object that contains columns for:</p>
<ul>
<li>Length of daylight in seconds: <code>dayl (s)</code></li>
<li>Precipitation in mm/day: <code>prcp (mm/day)</code></li>
<li>Average incoming solar radiation in Watts per m<sup>2</sup>: <code>srad (W/m^2)</code></li>
<li>Snow water equivalent in kg/m<sup>2</sup>: <code>swe (kg/m^2)</code></li>
<li>Maximum daily temperature in degrees Celsius: <code>tmax (deg c)</code></li>
<li>Minimum daily temperature in degrees Celsius: <code>tmin (deg c)</code></li>
<li>Average water vapor pressure in Pascals: <code>vp (Pa)</code></li>
</ul>
<p>For this lab, we are only interested in the Precipitation data, although the snow water equivalent data could be important for a cooler basin. Therefore we simply create a new <code>DataFrame</code> containing only the <code>prcp (mm/day)</code> data. We also create a column of the dates for each observation as we did with the discharge data.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> pd.DataFrame(daymet[<span class="st">'prcp (mm/day)'</span>])</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>P.columns <span class="op">=</span> [<span class="st">'P [mm/day]'</span>]</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>P[<span class="st">'Dates'</span>] <span class="op">=</span> P.index</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>P.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="run">
<pre><code>‚ñ∂Ô∏è &lt;b&gt; Run the cell below. &lt;/b&gt;</code></pre>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>P <span class="op">=</span> pd.DataFrame(daymet[<span class="st">'prcp (mm/day)'</span>])</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>P.columns <span class="op">=</span> [<span class="st">'P [mm/day]'</span>]</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>P.index.name <span class="op">=</span> <span class="st">'Datetime'</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>P[<span class="st">'Dates'</span>] <span class="op">=</span> P.index</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>P.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="evapotranspiration-data-for-our-station" class="level3">
<h3 class="anchored" data-anchor-id="evapotranspiration-data-for-our-station">3.3.3 Evapotranspiration Data for our Station</h3>
<p>Evapotranspiration data is the hardest to obtain as there are very few direct observations of evapotranspiration (but we will work with some of these direct measurements in our next lab!). Because evapotranspiration is dependent on atmospheric conditions and the amount of energy available to evaporate water at the surface, most attempts to characterize evapotranspiration focus on the <em>potential</em> rate at which water vapor can be transported from the surface into the atmosphere. However, in places where the availability of water limits the rate of evapotranspiration, the potential evapotranspiration (PET) can be much higher than actual rates. This makes determiniation of actual evapotranspiration quite difficult in water-limited regions.</p>
<p>Estimation of actual evapotranspiration can be accomplished using either mass balance approaches, energy balance approaches, or a combination of both. For this lab, we are going to use a model-based estimate of actual evapotranspiration called the Operational Simplified Surface Energy Balance (SSEBop) model, which was developed at the USGS‚Äôs Earth Resources Observation and Science (<a href="https://www.usgs.gov/centers/eros">EROS</a>) Center. This approach is presented in <a href="https://doi.org/10.13031/aea.12614">Senay (2018)</a> and <a href="https://doi.org/10.1111/jawr.12057">Senay et al., (2013)</a>. Unfortunately, there‚Äôs no web service available for subsetting the data. Therefore, the <code>hydrodata</code> routine, <code>ssebopeta_bygeom</code> first downloads the entire national dataset for the requested period and then subsets the data based on the provided geometry locally. For this reason, it‚Äôs not nearly fast as other operations and the bottleneck is download speed, which can vary greatly based on available bandwidth.</p>
<div class="data">
<pre><code>üìä &lt;b&gt;EROS Data Center&lt;/b&gt; EROS is home to the world's largest collection of remotely sensed images of the Earth‚Äôs land surface and the primary source of Landsat satellite images and data products. NASA‚Äôs Land Processes Distributed Active Archive Center (LP DAAC) is also located at EROS. EROS developed the SSEBop model that we are using in today's lab. A recent comparison of methods for estimating actual evapotranspiration can be found &lt;a href="https://pubs.usgs.gov/sir/2017/5087/sir20175087.pdf"&gt;here&lt;/a&gt;.</code></pre>
</div>
<p>We can access the SSEBop model estimates of evapotranspiration using the <code>ssedopeta_byloc</code> method:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>ET <span class="op">=</span> hds.ssebopeta_byloc(wshed.lon, wshed.lat, start<span class="op">=</span>wshed.start, end<span class="op">=</span>wshed.end)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="data">
<pre><code>üìä &lt;b&gt;SSEBop Data Availability&lt;/b&gt; The SSEBop output at EROS isn't provided in real-time. &lt;b&gt;As of May 2020 only data through the end of 2018 were available&lt;/b&gt;. More details on these products can be found &lt;a href="https://earlywarning.usgs.gov/ssebop/modis/daily"&gt;here&lt;/a&gt;.</code></pre>
</div>
<section id="downloading-a-single-water-year-of-et-data" class="level4">
<h4 class="anchored" data-anchor-id="downloading-a-single-water-year-of-et-data">Downloading a single water year of ET data</h4>
<p>As mentioned above, downloading the SSEBop data can take quite some time. We‚Äôve written a helper function that downloads a single water year of ET data at a time. The function requires a <code>station_id</code> as the first argument, and the requested water year as the second argument. It returns a pandas DataFrame containing ET values for each day in the water year.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> get_ET_wateryear <span class="im">import</span> get_ET_wateryear</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>ET_2015 <span class="op">=</span> get_ET_wateryear(station_id, <span class="dv">2015</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="run">
<pre><code>‚ñ∂Ô∏è &lt;b&gt; Run the cell below. &lt;/b&gt; &lt;br&gt;&lt;hr style="border-top: 0.5px solid gray;"&gt; NOTE: Currently, there are no methods to subset the SSEBop output before download. It takes a &lt;i&gt;very&lt;/i&gt; long time to download the daily national estimates for three full years (1,096 files). So we've pre-loaded the data as a CSV file for you in the class &lt;code&gt;data&lt;/code&gt; folder, and we will use that for now. When you complete your lab work, you can use the &lt;code&gt;get_ET_wateryear()&lt;/code&gt; function to get data for your gauge.</code></pre>
<hr style="border-top: 0.5px solid gray;">
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instead, load the data from a csv using the pd.read_csv() command:</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>ET <span class="op">=</span> pd.read_csv(<span class="st">'../data/lab_1/SSEBop_11123500.csv'</span>, usecols<span class="op">=</span>[<span class="st">'ET [mm/day]'</span>, <span class="st">'datetime'</span>], </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>                 index_col<span class="op">=</span><span class="st">'datetime'</span>, parse_dates<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Just as with our P and Q data, we assign the index and create a column of dates.</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>ET.index.name <span class="op">=</span> <span class="st">'Datetime'</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>ET[<span class="st">'Dates'</span>] <span class="op">=</span> ET.index</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>ET.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="summing-fluxes-by-water-year" class="level3">
<h3 class="anchored" data-anchor-id="summing-fluxes-by-water-year">3.3.4 Summing Fluxes by Water Year</h3>
<p>As we analyze our basin‚Äôs water balance, we will want to quickly look at the total amount of a flux at a gauge location for a single water year. To do so, we‚Äôd need to create a function that averages the correct months (October to September of the following year). To do so, we need to add a column that is water year. This is easy to do. First we create a <code>water_year</code> function.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> water_year(date):</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Determines the water year for a Dateteime date</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co">        date : Datetime obj</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co">            A datetime stored as the pandas datetime object. </span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co">        water_year : int</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co">            An integer corresponding to the water year of the datetime</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span> </span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> date.month<span class="op">&gt;=</span><span class="dv">10</span>:</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> date.year<span class="op">+</span><span class="dv">1</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> date.year</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="run">
<pre><code>‚ñ∂Ô∏è &lt;b&gt; Run the cell below. &lt;/b&gt;</code></pre>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> water_year(date):</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Determines the water year for a Dateteime date</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">        date : Datetime obj</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">            A datetime stored as the pandas datetime object. </span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co">        water_year : int</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="co">            An integer corresponding to the water year of the datetime</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span> </span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> date.month<span class="op">&gt;=</span><span class="dv">10</span>:</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> date.year<span class="op">+</span><span class="dv">1</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> date.year</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Having defined the <code>water_year()</code> function, we can easily <code>apply</code> this function to every value in the <code>Dates</code> column of the <code>P</code> dataframe. We assign this value to a new column in the <code>P</code> dataframe, which we will call <code>water_year</code>.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>P[<span class="st">'water_year'</span>] <span class="op">=</span> P[<span class="st">'Dates'</span>].<span class="bu">apply</span>(water_year)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="additional-hydromet-plotting-tools" class="level2">
<h2 class="anchored" data-anchor-id="additional-hydromet-plotting-tools">3.4 Additional Hydromet Plotting tools</h2>
<p>The <code>hydrodata</code> package includes a handy utility for plotting streamflow and rainfall. We can import this utility and use our data on <code>Q</code> and <code>P</code> to plot the timeseries of both over the past three years with the <code>signatures</code> function.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hydrodata <span class="im">import</span> plot <span class="im">as</span> hydroplot</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>hydroplot.signatures({<span class="st">"Q"</span>: (Q[<span class="st">'Q [m^3/s]'</span>], wshed.drainage_area)}, P[<span class="st">'P [mm/day]'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="run">
<pre><code>‚ñ∂Ô∏è &lt;b&gt; Run the cell below.</code></pre>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> hydrodata <span class="im">import</span> plot <span class="im">as</span> hydroplot</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>hydroplot.signatures({<span class="st">"Q"</span>: (Q[<span class="st">'Q [m^3/s]'</span>], wshed.drainage_area)}, P[<span class="st">'P [mm/day]'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The graphs above depict the timeseries of daily data as well as monthly and annual plots. Finally, it also includes a <em>Flow Duration Curve</em> plot, which shows the percent of time that flow was above different thresholds from the highest to the lowest values. These curves give a sense of how dynamic a river basin is with respect to discharge as well as the distribution of flow amounts. Reading the x-axis of the flow duration curve, we can see that the 50% exceedence flow (i.e.&nbsp;the average amount of streamflow) is somewhere around 0.005 mm/day, which is very low. That corresponds to the fact that we only really see high flows in the Sisquoc during the 2017 water year, and only very small peaks in flow for the 2016 and 2018 water years.</p>
</section>
<section id="your-assignment" class="level1">
<h1>4. Your Assignment</h1>
<p>Your assignment in this lab is to use the data we‚Äôve just collected to assess the water balance of the Sisquoc River. Each section of the Assignment is included below, with a summary of what you should do. We are not providing the code to do all of the calculations, but will show you the equations you need.</p>
<section id="assessing-basin-water-balance" class="level2">
<h2 class="anchored" data-anchor-id="assessing-basin-water-balance">4.1 Assessing Basin Water Balance</h2>
<section id="assign-a-water-year-for-each-entry-in-the-q-et-and-p-dataframes." class="level3">
<h3 class="anchored" data-anchor-id="assign-a-water-year-for-each-entry-in-the-q-et-and-p-dataframes.">4.1.0 Assign a water year for each entry in the <code>Q</code>, <code>ET</code>, and <code>P</code> dataframes.</h3>
<div class="practice">
<pre><code>üìö  &lt;b&gt; Question 4.1.0. &lt;/b&gt; 
Use the &lt;code&gt;water_year()&lt;/code&gt; function that we created in Section 3.3.4 to create a new &lt;code&gt;water_year&lt;/code&gt; column in the DataFrames for your three fluxes (Note: You may want ‚Äì but are not required ‚Äì to combine the three DataFrames into a single DataFrame that contains separate columns for &lt;code&gt;Q [mm/day]&lt;/code&gt;, &lt;code&gt;P [mm/day]&lt;/code&gt;, and &lt;code&gt;ET [mm/day]&lt;/code&gt;.  </code></pre>
</div>
</section>
<section id="convert-discharge-to-units-of-mmday" class="level3">
<h3 class="anchored" data-anchor-id="convert-discharge-to-units-of-mmday">4.1.1 Convert Discharge to units of mm/day</h3>
<div class="data">
<pre><code>üìä &lt;b&gt;Converting Units of Q&lt;/b&gt; The units of &lt;code&gt;Q&lt;/code&gt; that you have are in cubic meters per second, while your units of &lt;code&gt;P&lt;/code&gt; and &lt;code&gt;ET&lt;/code&gt; are both in units of millimeters per day. You need to convert the &lt;code&gt;Q&lt;/code&gt; values to mm/day. To do so, we need to figure out the discharge amount per unit area of the basin, which is converting the &lt;i&gt;flow&lt;/i&gt; (amount per time) to a &lt;i&gt;flux&lt;/i&gt; amount per time per unit area).</code></pre>
</div>
<p>Here are some helpful conversions and their rationale:</p>
<ol type="1">
<li><p>There are 86,400 <code>seconds</code> in one <code>day</code>. Therefore: $ 1 = 86,400 $</p></li>
<li><p>Convert <span class="math inline">1 \frac{ \mbox{m}^3}{\mbox{day}}</span> of streamflow to depth by dividing by the basin area in m<span class="math inline">^2</span>. (recall there are 1,000,000 m<sup>2</sup> per km<sup>2</sup>)</p></li>
</ol>
<div class="practice">
<pre><code>üìö  &lt;b&gt; Question 4.1.1. &lt;/b&gt; 
Use the conversions above to create a function that converts a streamflow in units of cubic meters per second into units of mm/day. Use the docstrings below to help make your function.</code></pre>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> Q_mm(Q_cms, basin_area<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">""" Convert discharge in units of m^3/s into units of mm/day.</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">    # The lines below are a doctest. </span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="co">    # If your function is working correctly, you should get 86.4</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co">    # when you call it using Q_mm(1, basin_area=1)</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co">    &gt;&gt;&gt; Q_mm(1, basin_area=1)</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="co">    86.4</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Q_cms : float</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a><span class="co">            Streamflow in units of [m^3/s]</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="co">        basin_area : float</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a><span class="co">            Upstream area of basin at location of flow measurement, km^2</span></span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Q_mm : float</span></span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="co">            Streamflow in units of mm/day</span></span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add your code here!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="python">
<pre><code>üêç &lt;b&gt;Doctests.&lt;/b&gt; 
The &lt;code&gt;docstrings&lt;/code&gt; in the cell above contain a &lt;code&gt;doctest&lt;/code&gt;. A &lt;code&gt;doctest&lt;/code&gt; is a portion of the &lt;code&gt;docstring&lt;/code&gt; that begins with &lt;code&gt;&gt;&gt;&gt;&lt;/code&gt;. This code can be run using the &lt;code&gt;doctest&lt;/code&gt; module, which then checks to make sure that the result of the code is the same as the value in the line below the doctest string. In this case, the &lt;doctest&gt; would check to see that when we call &lt;code&gt;Q_mm(1, basin_area=1)&lt;/code&gt;, the function returns &lt;code&gt;86.4&lt;/code&gt; (the correct value). Doctests ensure that your code is doing what you want, and are a good way to check your functions.</code></pre>
</div>
<p>We can run <code>doctest</code>s for any function in a Jupyter notebook by importing the <code>doctest</code> module and then using the <code>run_docstring_examples</code> method:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> doctest</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>doctest.run_docstring_examples(Q_mm, <span class="bu">globals</span>(), verbose<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="example">
<pre><code>‚úèÔ∏è &lt;b&gt; Try it. &lt;/b&gt; 
Once you've written your &lt;code&gt;Q_mm&lt;/code&gt; function so it returns Q in mm/day, run the docstrings using the code above to make sure it works. </code></pre>
</div>
</section>
<section id="apply-your-q_mm-function-to-the-q-dataframe-to-get-a-new-column-of-q-in-mmday." class="level3">
<h3 class="anchored" data-anchor-id="apply-your-q_mm-function-to-the-q-dataframe-to-get-a-new-column-of-q-in-mmday.">4.1.2 Apply your <code>Q_mm</code> function to the <code>Q</code> dataframe to get a new column of <code>Q</code> in <code>mm/day</code>.</h3>
<div class="practice">
<pre><code>üìö  &lt;b&gt; Question 4.1.2. &lt;/b&gt; 
Use the &lt;code&gt;apply&lt;/code&gt; method and your &lt;code&gt;Q_mm&lt;/code&gt; function to create a new column, &lt;code&gt;'Q [mm/day]'&lt;/code&gt; that has values of streamflow in mm/day. </code></pre>
</div>
</section>
<section id="create-a-plot-of-the-daily-change-in-storage-over-the-three-water-years." class="level3">
<h3 class="anchored" data-anchor-id="create-a-plot-of-the-daily-change-in-storage-over-the-three-water-years.">4.1.3 Create a plot of the daily change in storage over the three water years.</h3>
<p>Now that you have <span class="math inline">Q</span>, <span class="math inline">P</span>, and <span class="math inline">ET</span> all in the same units (mm/day), you can determine the daily change in storage:</p>
<p>$ S = P - ET - Q $</p>
<div class="practice">
<pre><code>üìö  &lt;b&gt; Question 4.1.3. &lt;/b&gt; 
Create a new DataFrame with the change in storage and plot the data for the three water years.</code></pre>
</div>
</section>
<section id="determine-average-monthly-water-balance" class="level3">
<h3 class="anchored" data-anchor-id="determine-average-monthly-water-balance">4.1.4 Determine average monthly water balance</h3>
<p>Use your measure of the change in storage to create a plot that contains the average monthly water balance across the three years of data. There will be one value of change in storage for each month of the water year.</p>
<div class="practice">
<pre><code>üìö  &lt;b&gt; Question 4.1.4. &lt;/b&gt; 
Use your measure of the change in storage to create a plot that contains the average monthly water balance across the three years of data. There will be one value of change in storage for each month of the water year.</code></pre>
</div>
</section>
<section id="assess-the-degree-to-which-this-basin-is-in-steady-state" class="level3">
<h3 class="anchored" data-anchor-id="assess-the-degree-to-which-this-basin-is-in-steady-state">4.1.5 Assess the degree to which this basin is in steady state</h3>
<p>As discussed above, under steady-state conditions the change in storage, <span class="math inline">\Delta S</span>, is zero and our equation reduces to:</p>
<p>$ P = ET + Q$</p>
<div class="practice">
<pre><code>üìö  &lt;b&gt; Question 4.1.5. &lt;/b&gt; </code></pre>
<p>Use your three years of data to determine if this basin is in steady state over the entire time period.</p>
</div>
</section>
<section id="determine-basin-runoff-coefficients" class="level3">
<h3 class="anchored" data-anchor-id="determine-basin-runoff-coefficients">4.1.6 Determine Basin Runoff Coefficients</h3>
<p>The runoff ratio or runoff coefficient, <span class="math inline">R_c</span>, is defined as the fraction of rainfall that leaves a basin through streamflow over a period of time.</p>
<p>$ R_{c} = $</p>
<p>The runoff coefficient is larger value for areas with low infiltration and high runoff (pavement, steep gradient), and lower for permeable, well vegetated areas (forest, flat land). The ratio is important for flood control, channel construction, and for possible flood zone hazard delineation. A high <span class="math inline">R_c</span> value may indicate flash flooding areas during storms as water moves fast overland on its way to a river channel or a valley floor.</p>
<div class="practice">
<pre><code>üìö  &lt;b&gt; Question 4.1.6.&lt;/b&gt; </code></pre>
<p>Calculate the runoff ratio for the months with the 5 highest rainfalls during the three year record.</p>
</div>
</section>
</section>
<section id="choose-your-own-basin." class="level2">
<h2 class="anchored" data-anchor-id="choose-your-own-basin.">4.2 Choose your own basin.</h2>
<p>Use all of the example and assignment text to create an analysis of a USGS basin of your choosing. You can browse a map of all stream gauge locations in the US at the <a href="https://maps.waterdata.usgs.gov/mapper/index.html">maps.waterdata.usgs.gov</a> site. Select a basin that is near a place you‚Äôve lived, or a part of the country that you have visited or has some meaning to you.</p>
<p>Your analysis should include:</p>
<ol type="1">
<li>A plot of the basin hydrography</li>
<li>A plot of the basin topography</li>
<li>A plot of average rainfall, streamflow and runoff ratio by month</li>
<li>A single year of waterbalance analysis. Note: Because obtaining ET data is slow, you should pick a single year between 2000 and 2018 to calculate your basin waterbalance. Use the <code>get_ET_wateryear()</code> function.</li>
</ol>
<section id="some-local-gauges-of-possible-interest" class="level3">
<h3 class="anchored" data-anchor-id="some-local-gauges-of-possible-interest">Some Local Gauges of Possible Interest:</h3>
<ul>
<li><a href="https://waterdata.usgs.gov/nwis/inventory/?site_no=11119500">Carpinteria Creek</a> in Carpinteria, Station ID 11119500</li>
</ul>
<pre class="pyton"><code>carpinteria_id = '11119500' </code></pre>
<ul>
<li><a href="https://waterdata.usgs.gov/nwis/inventory/?site_no=11119750">Mission Creek</a> in Santa Barbara, Station ID 11119750</li>
</ul>
<div class="sourceCode" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>mission_id <span class="op">=</span> <span class="st">'11119750'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><a href="https://waterdata.usgs.gov/nwis/inventory/?site_no=11120000">Atascadero Creek</a> in Goleta, Station ID 11120000</li>
</ul>
<div class="sourceCode" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>atascadero_id <span class="op">=</span> <span class="st">'11120000'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
</section>
<section id="extra-stuff-land-use-data" class="level1">
<h1>5. Extra Stuff: Land Use Data</h1>
<p>While we don‚Äôt use it in this lab, <code>hydrodata</code> also makes it possible to access land use and land cover data can be obtained from the Multi-Resolution Land Characteristics (MRLC) Consortium. By default the data are downloaded from NLCD 2016.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>lulc <span class="op">=</span> hds.nlcd(wshed.geometry, resolution<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-scrolled="true">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rasterio.plot <span class="im">import</span> show</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>cmap, norm, levels <span class="op">=</span> hydroplot.cover_legends()</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>fig, (ax1, ax2, ax3) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">21</span>, <span class="dv">7</span>), dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>show(lulc[<span class="st">'canopy'</span>], ax<span class="op">=</span>ax1, title<span class="op">=</span><span class="ss">f'Canopy 2016'</span>, cmap<span class="op">=</span><span class="st">'Greens'</span>)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>show(lulc[<span class="st">'cover'</span>], ax<span class="op">=</span>ax2, title<span class="op">=</span><span class="ss">f'Cover 2016'</span>, cmap<span class="op">=</span>cmap, norm<span class="op">=</span>norm)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>show(lulc[<span class="st">'impervious'</span>], ax<span class="op">=</span>ax3, title<span class="op">=</span><span class="ss">f'Impervious 2016'</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr style="border-top: 1px solid gray; margin-top: 24px; margin-bottom: 1px">

<div class="cell" data-cell.metadata.hide_input="True">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.core.display <span class="im">import</span> HTML</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> css_styling():</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    styles <span class="op">=</span> <span class="bu">open</span>(<span class="st">"./styles/exercises.css"</span>, <span class="st">"r"</span>).read()</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> HTML(styles)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>css_styling()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display" data-execution_count="1">
<style>
    div.run { 
        border: 0.5px solid #008C96; 
        padding: 10px; 
        background-color: #b2dcdf; 
        color:#006269; 
        margin-top: 12px; 
        font-weight: bold
    }
    div.example { 
        border: 0.5px solid #008C96; 
        padding: 10px; 
        background-color: #b2dcdf; 
        color:#006269; 
        margin-top: 12px;
        font-weight: bold
    }
    div.practice { 
        border: 0.5px solid #008C96;  
        padding: 10px;  
        background-color: #b2dcdf;  
        color:#006269; 
        margin-top: 12px;
        font-weight: bold
    }
    div.python { 
        border: 0.5px solid #408000; 
        padding: 10px; 
        background-color: #cddfb4; 
        color:#2c5900; 
        margin-top: 12px
    }
    div.data { 
        border: 0.5px solid #443823; 
        padding: 10px; 
        background-color: #ead8b9; 
        color:#443823; 
        margin-top: 12px
    }
    div.codeblock { 
        border: 0.2px solid #808080;
        padding: 10px; 
        background-color: #DBDBDB; 
        margin-top: 2px
    }   
    div.boxhead1 { 
        border-radius: 4px 4px 0px 0px; 
        padding: 6px; 
        border: 0.5px solid #008C96; 
        background-color: #b2dcdf; 
        color:#006269; 
        margin-top: 12px; 
        font-size: 115%; 
        font-weight: bold
    }
    div.boxtext1 { 
        border-radius: 0px 0px 4px 4px; 
        border: 0.5px solid #008C96; 
        padding: 12pt; 
        color:#006269 
    }
    div.boxhead2 {
        border-radius: 4px 4px 0px 0px; 
        padding: 6px; border: 0.5px solid #73AD21; 
        background-color: #c7dea6; 
        color:#486d15; 
        margin-top: 12px; 
        font-size: 115%; 
        font-weight: bold
    }
    div.boxtext2 { 
        border-radius: 0px 0px 4px 4px; 
        border: 0.5px solid #73AD21; 
        padding: 12pt; 
        color:#486d15
    }
    span.code {
        font-family: Lucida Console, Courier, monospace;
        font-weight: normal;
    }
    span.codeb {
        font-family: Lucida Console, Courier, monospace;
        font-weight: bold;
    }
    ol.num {
        margin: 0pt;
        margin-top: 12pt; 
        margin-bottom: 2pt; 
        margin-left: 4pt; 
        padding-bottom: 4pt; 
    }
    ol.alpha {
        list-style-type: lower-alpha;
        margin: 0pt;
        margin-left: 4pt;
        margin-top: 2pt;
        font-weight: bold
    }
    ul.a {
        list-style-type: none; 
        margin-left: -20pt;
        font-weight: bold;
    }

    ul.b {
        list-style-type: square; 
        font-weight: normal; 
        margin-left: 20pt; 
        margin-top: 4pt; 
        padding-bottom: 12pt;
    }
</style>
</div>
</div>


</section>

</code></main><code> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</code></div><code> <!-- /content -->



</code></body></html>